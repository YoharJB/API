name: Mover archivos a API

on:
  workflow_dispatch:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  move-to-api-repo:
    runs-on: ubuntu-latest
    steps:
      # Chequear el c贸digo del repositorio principal
      - name: Checkout principal repo
        uses: actions/checkout@v4
        with:
          repository: YoharJB/API
          token: ${{ secrets.BOT }}
          ref: main

      # Chequear el c贸digo del repositorio de API
      - name: Checkout repo API-RAW
        uses: actions/checkout@v4
        with:
          repository: YoharJB/API-RAW
          token: ${{ secrets.BOT }}
          path: API-RAW
          ref: main

      # Mover los archivos
      - name: Mover archivos
        run: |
          # Usar rsync para mover y actualizar todos los archivos
          rsync -av ./API/Addons/ ./API-RAW/API/Addons/

      # Combinar contenido de JSONs
      - name: Actualizar Maddons.json
        run: |
          # Definir rutas de los archivos
          DEST_MADDONS_JSON="./API-RAW/API/Maddons.json"
          TEMP_MADDONS_JSON="./API-RAW/API/Maddons_temp.json"
          
          # Buscar JSON subido por el usuario en el repo API
          USER_JSON=$(find ./API -maxdepth 1 -name '*.json' -print -quit)

          # Si no se subi贸 un JSON, no hacemos nada
          if [ -f "$USER_JSON" ]; then
            echo "Procesando archivo JSON del usuario: $USER_JSON"

            # Combinar el JSON subido con el Maddons.json existente
            jq -s '.[0] + .[1]' "$DEST_MADDONS_JSON" "$USER_JSON" > "$TEMP_MADDONS_JSON"
            
            # Reemplazar el Maddons.json original con el combinado
            mv "$TEMP_MADDONS_JSON" "$DEST_MADDONS_JSON"
          else
            echo "No se encontr贸 un archivo JSON en API, Maddons.json permanece sin cambios."
          fi

      # Commit de los cambios en el repositorio de API-RAW
      - name: Commit y push cambios
        uses: cpina/github-action-push-to-another-repository@main
        with:
          source-directory: "API-RAW"
          destination-github-username: YoharJB
          destination-repository-name: API-RAW
          user-email: "actions@github.com"
          user-name: "GitHub Actions"
        env:
          API_TOKEN_GITHUB: ${{ secrets.BOT }}

      # Eliminar archivos procesados en API
      - name: Eliminar archivos procesados
        run: |
          # Eliminar archivos y directorios procesados en API
          rm -rf ./API/Addons/Lichking/*
          rm -rf ./API/Addons/Cataclysm/*
          rm -rf ./API/Addons/Pandaria/*
          rm -rf ./API/Addons/Vanilla/*
          rm -rf ./API/Addons/TBC/*
          find ./API -maxdepth 1 -name '*.json' -delete
